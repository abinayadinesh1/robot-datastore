<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stream Viewer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Fullscreen tile styles — can't be done with Tailwind alone */
    .stream-tile:fullscreen {
      background: black;
      display: flex;
      flex-direction: column;
    }
    .stream-tile:fullscreen .tile-body {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .stream-tile:fullscreen .tile-body img {
      max-width: 100vw;
      max-height: calc(100vh - 40px);
      width: auto;
      height: auto;
      object-fit: contain;
    }
    .stream-tile:fullscreen .tile-header {
      opacity: 0;
      transition: opacity 0.2s;
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      z-index: 10;
    }
    .stream-tile:fullscreen:hover .tile-header {
      opacity: 1;
    }
    /* Smooth pulse for connecting state */
    @keyframes pulse-dot {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }
    .pulse-dot {
      animation: pulse-dot 1.2s ease-in-out infinite;
    }
  </style>
</head>
<body class="bg-gray-950 text-gray-100 min-h-screen flex flex-col font-mono">

  <!-- Toolbar -->
  <header class="bg-gray-900 border-b border-gray-800 px-4 py-2 flex items-center justify-between shrink-0">
    <div class="flex items-center gap-3">
      <span class="text-sm font-semibold text-gray-200 tracking-wide">Stream Viewer</span>
      <span id="stream-count" class="text-xs bg-gray-800 text-gray-400 px-2 py-0.5 rounded-full">0 streams</span>
    </div>
    <button
      id="add-btn"
      class="flex items-center gap-1.5 text-xs bg-indigo-600 hover:bg-indigo-500 active:bg-indigo-700 text-white px-3 py-1.5 rounded-md transition-colors"
    >
      <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
      </svg>
      Add new source
    </button>
  </header>

  <!-- Stream grid -->
  <main class="flex-1 p-2 overflow-auto">
    <div id="empty-state" class="hidden flex-col items-center justify-center h-full min-h-[60vh] text-gray-600">
      <svg xmlns="http://www.w3.org/2000/svg" class="w-16 h-16 mb-4 opacity-30" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M15 10l4.553-2.069A1 1 0 0121 8.82v6.36a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
      </svg>
      <p class="text-sm">No streams. Click <strong class="text-gray-500">Add new source</strong> to get started.</p>
    </div>
    <div id="grid" style="display:grid; gap:0.5rem;"></div>
  </main>

  <!-- Add new source modal -->
  <div id="modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50" role="dialog" aria-modal="true">
    <div class="bg-gray-900 border border-gray-700 rounded-xl p-6 w-full max-w-md shadow-2xl">
      <h2 class="text-base font-semibold text-gray-100 mb-4">Add new source</h2>
      <div class="space-y-3 mb-2">
        <div>
          <label class="block text-xs text-gray-400 mb-1">Label</label>
          <input
            id="modal-label"
            type="text"
            placeholder="e.g. Front Camera"
            class="w-full bg-gray-800 border border-gray-700 rounded-md px-3 py-2 text-sm text-gray-100 placeholder-gray-600 focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500"
          >
        </div>
        <div>
          <label class="block text-xs text-gray-400 mb-1">Stream URL</label>
          <input
            id="modal-url"
            type="text"
            class="w-full bg-gray-800 border border-gray-700 rounded-md px-3 py-2 text-sm text-gray-100 placeholder-gray-600 focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500"
          >
          <p class="text-xs text-gray-600 mt-1">Hint: append <code class="text-gray-500">?fps=10&quality=60</code> to limit bandwidth</p>
        </div>
      </div>
      <div class="flex gap-2 justify-end pt-2">
        <button id="modal-cancel" class="text-xs text-gray-400 hover:text-gray-200 px-3 py-1.5 rounded-md transition-colors">Cancel</button>
        <button id="modal-add" class="text-xs bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-1.5 rounded-md transition-colors">Add stream</button>
      </div>
    </div>
  </div>

  <script>
    // ─── Helpers ──────────────────────────────────────────────────────────────
    function escHtml(s) {
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    // ─── Constants ────────────────────────────────────────────────────────────
    const STORAGE_KEY = 'streamViewer.streams';
    const NEXT_ID_KEY = 'streamViewer.nextId';
    const DEFAULT_URL  = 'http://100.107.96.29:8000/api/camera/stream';

    // ─── State ────────────────────────────────────────────────────────────────
    const state = {
      streams: [],   // [{ id, label, url }]
      nextId: 1,
    };

    // ─── Persistence ─────────────────────────────────────────────────────────
    function save() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state.streams));
      localStorage.setItem(NEXT_ID_KEY, state.nextId);
    }

    async function loadInitial() {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (saved) {
        try {
          state.streams = JSON.parse(saved);
          state.nextId  = parseInt(localStorage.getItem(NEXT_ID_KEY) || '1', 10);
          return;
        } catch (_) { /* fall through */ }
      }
      // First load: try sources.json
      try {
        const res  = await fetch('sources.json');
        const data = await res.json();
        if (Array.isArray(data.streams)) {
          data.streams.forEach(s => {
            state.streams.push({ id: state.nextId++, label: s.label || 'Camera', url: s.url });
          });
          save();
          return;
        }
      } catch (_) { /* fall through */ }
      // Final fallback
      state.streams.push({ id: state.nextId++, label: 'Front Camera', url: DEFAULT_URL });
      save();
    }

    // ─── Grid layout ──────────────────────────────────────────────────────────
    const grid = document.getElementById('grid');
    const emptyState = document.getElementById('empty-state');
    const streamCount = document.getElementById('stream-count');

    function updateLayout() {
      const n = state.streams.length;
      const cols = n <= 1 ? 1 : n === 2 ? 2 : 3;
      grid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
      streamCount.textContent = `${n} stream${n !== 1 ? 's' : ''}`;
      emptyState.style.display = n === 0 ? 'flex' : 'none';
      grid.style.display = n === 0 ? 'none' : 'grid';
    }

    // ─── Tile creation ────────────────────────────────────────────────────────
    function createTile(stream) {
      const tile = document.createElement('div');
      tile.className = 'stream-tile relative bg-gray-900 rounded-lg overflow-hidden border border-gray-800 flex flex-col';
      tile.dataset.id = stream.id;
      tile.style.minHeight = '240px';

      // Header
      const header = document.createElement('div');
      header.className = 'tile-header flex items-center justify-between px-3 py-1.5 bg-gray-900/90 backdrop-blur-sm border-b border-gray-800 z-10 shrink-0';
      header.innerHTML = `
        <span class="tile-label text-xs text-gray-300 truncate max-w-[60%] cursor-pointer hover:text-white" title="Click to rename">${escHtml(stream.label)}</span>
        <div class="flex items-center gap-1">
          <button data-action="fullscreen" title="Fullscreen" class="p-1 text-gray-500 hover:text-gray-200 transition-colors rounded">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h4a1 1 0 010 2H6.414l2.293 2.293a1 1 0 11-1.414 1.414L5 6.414V8a1 1 0 01-2 0V4zm9 1a1 1 0 010-2h4a1 1 0 011 1v4a1 1 0 01-2 0V6.414l-2.293 2.293a1 1 0 11-1.414-1.414L13.586 5H12zm-9 7a1 1 0 012 0v1.586l2.293-2.293a1 1 0 111.414 1.414L6.414 15H8a1 1 0 010 2H4a1 1 0 01-1-1v-4zm13-1a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 010-2h1.586l-2.293-2.293a1 1 0 111.414-1.414L15 13.586V12a1 1 0 011-1z" clip-rule="evenodd"/>
            </svg>
          </button>
          <button data-action="remove" title="Remove stream" class="p-1 text-gray-500 hover:text-red-400 transition-colors rounded">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
            </svg>
          </button>
        </div>
      `;

      // Body
      const body = document.createElement('div');
      body.className = 'tile-body relative flex-1 bg-black overflow-hidden';

      // Status overlay
      const overlay = document.createElement('div');
      overlay.className = 'status-overlay absolute inset-0 flex flex-col items-center justify-center bg-gray-950/80 z-10 text-xs text-gray-500';
      overlay.innerHTML = `<span class="pulse-dot w-2 h-2 bg-yellow-500 rounded-full mb-2"></span><span class="status-text">Connecting…</span>`;

      // Stream image — the core: browser-native MJPEG decoding
      const img = document.createElement('img');
      img.className = 'w-full h-full object-contain';
      img.loading = 'eager';
      img.decoding = 'async';
      img.alt = stream.label;

      body.appendChild(overlay);
      body.appendChild(img);
      tile.appendChild(header);
      tile.appendChild(body);

      // Wire up event handlers
      attachStreamHandlers(img, overlay, stream.id, stream.url);
      attachTileHandlers(tile, header, stream.id);

      // Start streaming
      img.src = stream.url;

      return tile;
    }

    // ─── Stream connection handlers ───────────────────────────────────────────
    function attachStreamHandlers(img, overlay, streamId, url) {
      let retryDelay = 2000;
      let retryTimer = null;
      let countdown = null;

      function setOverlay(mode, secondsLeft) {
        const dot  = overlay.querySelector('.pulse-dot');
        const text = overlay.querySelector('.status-text');
        if (mode === 'live') {
          overlay.style.display = 'none';
        } else if (mode === 'connecting') {
          overlay.style.display = 'flex';
          dot.className  = 'pulse-dot w-2 h-2 bg-yellow-500 rounded-full mb-2';
          text.textContent = 'Connecting…';
        } else if (mode === 'error') {
          overlay.style.display = 'flex';
          dot.className  = 'w-2 h-2 bg-red-500 rounded-full mb-2';
          text.textContent = secondsLeft > 0 ? `Reconnecting in ${secondsLeft}s…` : 'Reconnecting…';
        }
      }

      img.onload = () => {
        clearTimeout(retryTimer);
        clearInterval(countdown);
        retryDelay = 2000;
        setOverlay('live');
      };

      img.onerror = () => {
        clearTimeout(retryTimer);
        clearInterval(countdown);

        let secs = Math.round(retryDelay / 1000);
        setOverlay('error', secs);

        // Countdown display
        countdown = setInterval(() => {
          secs--;
          const text = overlay.querySelector('.status-text');
          if (text) text.textContent = secs > 0 ? `Reconnecting in ${secs}s…` : 'Reconnecting…';
        }, 1000);

        retryTimer = setTimeout(() => {
          clearInterval(countdown);
          setOverlay('connecting');
          // Cache-bust forces a new HTTP connection; FastAPI ignores unknown params
          const sep = url.includes('?') ? '&' : '?';
          img.src = url + sep + '_t=' + Date.now();
          retryDelay = Math.min(retryDelay * 2, 30000);
        }, retryDelay);
      };
    }

    // ─── Tile interaction handlers ────────────────────────────────────────────
    function attachTileHandlers(tile, header, streamId) {
      const labelEl = header.querySelector('.tile-label');

      // Inline label rename
      labelEl.addEventListener('click', () => {
        const current = labelEl.textContent;
        const input = document.createElement('input');
        input.type = 'text';
        input.value = current;
        input.className = 'text-xs bg-gray-800 border border-gray-600 rounded px-1 py-0.5 text-gray-100 w-full max-w-[60%] focus:outline-none focus:border-indigo-500';
        labelEl.replaceWith(input);
        input.focus();
        input.select();

        function commit() {
          const val = input.value.trim() || current;
          const stream = state.streams.find(s => s.id === streamId);
          if (stream) stream.label = val;
          save();
          const span = document.createElement('span');
          span.className = labelEl.className;
          span.title = 'Click to rename';
          span.textContent = val;
          input.replaceWith(span);
          attachLabelClick(span, streamId);
        }
        input.addEventListener('blur', commit);
        input.addEventListener('keydown', e => {
          if (e.key === 'Enter') { e.preventDefault(); input.blur(); }
          if (e.key === 'Escape') { input.value = current; input.blur(); }
        });
      });

      // Button actions (fullscreen / remove)
      header.addEventListener('click', e => {
        const btn = e.target.closest('[data-action]');
        if (!btn) return;
        const action = btn.dataset.action;
        if (action === 'fullscreen') {
          tile.requestFullscreen?.() ?? tile.webkitRequestFullscreen?.();
        } else if (action === 'remove') {
          removeStream(streamId);
        }
      });
    }

    function attachLabelClick(span, streamId) {
      // Re-attach after DOM replacement (label rename creates a new element)
      span.addEventListener('click', () => {
        const tile = document.querySelector(`[data-id="${streamId}"]`);
        if (tile) tile.querySelector('.tile-label').click();
      });
    }

    // ─── Stream management ────────────────────────────────────────────────────
    function addStream(label, url) {
      state.streams.push({ id: state.nextId++, label, url });
      save();
      render();
    }

    function removeStream(id) {
      state.streams = state.streams.filter(s => s.id !== id);
      save();
      render();
    }

    // ─── Render (DOM diffing — never recreate existing img tags) ─────────────
    function render() {
      const existingIds = new Set([...grid.children].map(el => +el.dataset.id));
      const newIds      = new Set(state.streams.map(s => s.id));

      // Remove tiles no longer in state
      for (const el of [...grid.children]) {
        if (!newIds.has(+el.dataset.id)) el.remove();
      }

      // Append only new tiles (never touch existing ones — would kill HTTP connection)
      for (const stream of state.streams) {
        if (!existingIds.has(stream.id)) {
          grid.appendChild(createTile(stream));
        }
      }

      updateLayout();
    }

    // ─── Modal ────────────────────────────────────────────────────────────────
    const modal       = document.getElementById('modal');
    const modalLabel  = document.getElementById('modal-label');
    const modalUrl    = document.getElementById('modal-url');
    const modalAdd    = document.getElementById('modal-add');
    const modalCancel = document.getElementById('modal-cancel');

    function openModal() {
      modalLabel.value = '';
      modalUrl.value   = DEFAULT_URL;
      modal.classList.remove('hidden');
      modalLabel.focus();
    }

    function closeModal() {
      modal.classList.add('hidden');
    }

    function submitModal() {
      const url   = modalUrl.value.trim();
      const label = modalLabel.value.trim() || 'Camera';
      if (!url) { modalUrl.focus(); return; }
      addStream(label, url);
      closeModal();
    }

    document.getElementById('add-btn').addEventListener('click', openModal);
    modalCancel.addEventListener('click', closeModal);
    modalAdd.addEventListener('click', submitModal);

    modal.addEventListener('click', e => { if (e.target === modal) closeModal(); });

    document.addEventListener('keydown', e => {
      if (e.key === 'Escape' && !modal.classList.contains('hidden')) closeModal();
      if (e.key === 'Enter'  && !modal.classList.contains('hidden')) {
        if (document.activeElement !== modalCancel) submitModal();
      }
    });

    // ─── Boot ─────────────────────────────────────────────────────────────────
    loadInitial().then(() => render());
  </script>
</body>
</html>
